<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EY GDS CONSULTING QUIZ WARS</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

  :root{
    --bg:#0b1220;
    --bg-grad1:#0f172a; --bg-grad2:#0b1220;
    --text:#e5e7eb; --muted:#93a4b7;
    --ring:#22d3ee; --accent:#38bdf8; --accent2:#a78bfa; --danger:#ef4444;
    --glass: rgba(255,255,255,.06);
    --glass-weak: rgba(255,255,255,.04);
    --glass-strong: rgba(255,255,255,.12);
    --stroke: rgba(255,255,255,.18);
    --radius: 16px;
    --shadow-lg: 0 30px 60px rgba(0,0,0,.45), 0 8px 20px rgba(0,0,0,.35);
    --shadow: 0 10px 30px rgba(0,0,0,.45);
    --blur: 18px;
  }

  *{ box-sizing:border-box }
  html,body{height:100%}
  body{
    margin:0; font-family:'Poppins',sans-serif; color:var(--text);
    background:
      radial-gradient(1000px 600px at 100% -10%, rgba(56,189,248,.10), transparent 60%),
      radial-gradient(900px 500px at -10% 20%, rgba(167,139,250,.10), transparent 60%),
      linear-gradient(180deg, var(--bg-grad1), var(--bg-grad2));
  }

  .panel-grid::before{
    content:""; position:fixed; inset:0; pointer-events:none; opacity:.28; mix-blend-mode:soft-light;
    background:
      linear-gradient(to right, rgba(255,255,255,.05) 1px, transparent 1px) 0 0/140px 140px,
      linear-gradient(to bottom, rgba(255,255,255,.04) 1px, transparent 1px) 0 0/140px 140px;
    z-index:0;
  }
  .noise{
    position:fixed; inset:0; pointer-events:none; opacity:.06; mix-blend-mode:overlay; z-index:0;
    background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.6"/></svg>');
  }

  .glass{
    position:relative; z-index:1;
    background: linear-gradient(180deg, var(--glass), rgba(255,255,255,.03));
    border:1px solid transparent; border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    backdrop-filter: blur(var(--blur)) saturate(115%);
    -webkit-backdrop-filter: blur(var(--blur)) saturate(115%);
    overflow:hidden;
  }
  .glass::before{
    content:""; position:absolute; inset:0; border-radius:inherit; padding:1px;
    background: linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.08));
    -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude; pointer-events:none;
  }
  .glass::after{
    content:""; position:absolute; left:0; right:0; top:0; height:32%;
    background: linear-gradient(180deg, rgba(255,255,255,.18), transparent);
    pointer-events:none;
  }
  .float{ transition:transform .18s ease }
  .float:hover{ transform: translateY(-2px) scale(1.003) }

  header.appbar.glass{
    position:sticky; top:0; z-index:50; display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px;
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.08);
    box-shadow: var(--shadow-lg);
    backdrop-filter: blur(14px) saturate(120%);
    -webkit-backdrop-filter: blur(14px) saturate(120%);
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:40px;height:40px;border-radius:10px;display:grid;place-items:center;
    background:#0b1220;border:1px solid rgba(255,255,255,.12); overflow:hidden; box-shadow: var(--shadow);
  }
  .logo img{width:100%;height:100%;object-fit:contain}
  .brand h1{margin:0;font-size:clamp(18px, 2.6vw, 28px);letter-spacing:.3px;font-weight:600}

  .btn{
    border:1px solid rgba(255,255,255,.14);
    background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
    color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer;
    transition:all .18s ease; font-family:inherit; font-size:14px; box-shadow:0 8px 18px rgba(0,0,0,.25);
    backdrop-filter: blur(8px);
  }
  .btn:hover{border-color:var(--ring); box-shadow:0 0 0 3px rgba(34,211,238,.18) inset, 0 10px 22px rgba(0,0,0,.3)}
  .btn.primary{
    background:linear-gradient(180deg, rgba(56,189,248,.22), rgba(56,189,248,.10));
    border-color:rgba(56,189,248,.45)
  }
  .btn.danger{
    background:linear-gradient(180deg, rgba(239,68,68,.28), rgba(239,68,68,.12));
    border-color:rgba(239,68,68,.55); color:#fff
  }
  .btn.small{padding:6px 10px; font-size:12px; border-radius:10px}

  .card.glass{ width:min(1100px, 96%); margin:22px auto; padding:16px }

  .table-wrap{overflow:auto;border-radius:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  thead th{text-align:left;font-weight:700;color:var(--muted);font-size:13px;padding:0 12px}
  tbody tr{
    background:var(--glass-weak);
    border:1px solid rgba(255,255,255,.10);
    transition: transform .12s ease, background .2s, box-shadow .2s;
    backdrop-filter: blur(6px);
  }
  tbody tr:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.07);
    box-shadow: 0 8px 20px rgba(0,0,0,.25);
  }
  td{padding:12px 12px;vertical-align:middle;font-size:16px;position:relative}
  .rank{width:68px;text-align:center;font-weight:800}
  .medal{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:10px;font-weight:800}
  .m1{background: linear-gradient(180deg, #fde68a, #f59e0b);color:#1f2937}
  .m2{background: linear-gradient(180deg, #e5e7eb, #9ca3af);color:#111827}
  .m3{background: linear-gradient(180deg, #f9a8d4, #ec4899);color:#1f2937}
  .name{outline:none;border-bottom:1px dashed transparent}
  .name:focus{border-bottom-color: var(--ring)}
  .locked-points{display:inline-block;min-width:100px;text-align:right;font-size:22px;font-weight:700;padding:6px 0;cursor:pointer}

  .row-actions{opacity:0;transition:opacity .2s ease;display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
  tr.show-actions .row-actions{opacity:1;}

  .bar{position:relative;height:8px;background:#0b1220;border:1px solid rgba(255,255,255,.10);border-radius:999px;overflow:hidden}
  .bar > span{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg, var(--accent), var(--accent2));transition: inset .3s ease}

  .menu.glass{
    position:fixed; top:0; right:0; width:min(420px, 92vw); height:100%; padding:18px;
    transform:translateX(100%); transition:transform .28s ease; z-index:60; overflow:auto;
    border-left:1px solid rgba(255,255,255,.10);
    border-top-left-radius:16px; border-bottom-left-radius:16px;
  }
  .menu.open{ transform:translateX(0) }
  .menu header{ display:flex; align-items:center; justify-content:space-between; gap:8px; background:none; padding:0 0 12px 0; border-bottom:1px solid rgba(255,255,255,.08) }
  .menu h2{ margin:0; font-size:18px; font-weight:600 }

  .backdrop{ position:fixed; inset:0; background:rgba(2,6,23,.60); backdrop-filter:blur(2px); opacity:0; pointer-events:none; transition:opacity .28s ease; z-index:55 }
  .backdrop.show{ opacity:1; pointer-events:auto }

  .group.subglass{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.10);
    padding:12px; border-radius:12px; margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    backdrop-filter: blur(10px);
  }
  .menu input[type="text"], .menu input[type="number"]{
    flex:1; min-width:0; background:#0b1220; color:var(--text);
    border:1px solid rgba(255,255,255,.14); border-radius:10px; padding:10px; font-family:inherit
  }
  .menu .label{font-size:12px; color:var(--muted); width:100%; margin-top:6px}
</style>
</head>
<body class="panel-grid">
  <div class="noise"></div>

  <header class="appbar glass float">
    <div class="brand">
      <div class="logo">
        <img alt="EY logo" src="https://cdn.cookielaw.org/logos/e398929d-19d8-4936-8936-5b2be51a20f3/5f876ef1-4827-47f5-8436-9287c8e8934f/1488bc3b-aa51-4f4f-aa24-fbc88f6afd1f/ey-white-logo.png">
      </div>
      <div><h1>EY GDS CONSULTING QUIZ WARS</h1></div>
    </div>
    <div style="display:flex; gap:8px; align-items:center">
      <button id="menuToggle" class="btn primary">☰ Menu</button>
      <button id="resetAll" class="btn danger">Reset All</button>
    </div>
  </header>

  <main class="card glass float" id="canvasArea">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="rank">#</th>
            <th>Team</th>
            <th>Points</th>
            <th style="width:420px">Actions / Progress</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </main>

  <!-- Slide-in Menu -->
  <aside class="menu glass" id="menu" aria-hidden="true" aria-label="Leaderboard menu">
    <header>
      <h2>Controls</h2>
      <button id="menuClose" class="btn" aria-label="Close menu">✕</button>
    </header>

    <div class="group subglass">
      <form id="addTeamForm" autocomplete="off" style="display:contents">
        <input id="teamName" type="text" placeholder="Team name" required />
        <input id="startPoints" type="number" placeholder="Start points" value="0" step="1" />
        <button type="submit" class="btn primary">Add Team</button>
      </form>
    </div>

    <div class="group subglass" style="gap:6px">
      <div class="label">Manual sort</div>
      <button class="btn small" data-sort="team-asc">Team A–Z</button>
      <button class="btn small" data-sort="team-desc">Team Z–A</button>
      <button class="btn small" data-sort="points-desc">Points High→Low</button>
      <button class="btn small" data-sort="points-asc">Points Low→High</button>
      <button class="btn small" data-sort="none" title="Original order from DB">Clear sort</button>
    </div>

    <!-- NEW: Export group -->
    <div class="group subglass" style="gap:6px">
      <div class="label">Export</div>
      <button id="downloadCsv" class="btn small">Download Results (CSV)</button>
    </div>
  </aside>
  <div class="backdrop" id="backdrop"></div>

  <!-- Firebase (compat for simplicity) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAd6gC7l3BfqUhHSo51CB4klsPGgJOMl1g",
  authDomain: "quizwars-46217.firebaseapp.com",
  projectId: "quizwars-46217",
  storageBucket: "quizwars-46217.firebasestorage.app",
  messagingSenderId: "807293495424",
  appId: "1:807293495424:web:fdc0c9d1bdbe09a0fe1e65",
  measurementId: "G-PVX6QHHFP6"
};

  // --- Firebase init ---
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const COL = db.collection('quizwars_teams'); // change name if you want separate boards

  // --- UI state ---
  let teams = [];           // hydrated from Firestore
  let currentSort = 'none'; // 'team-asc' | 'team-desc' | 'points-asc' | 'points-desc' | 'none'
  const rows = document.getElementById('rows');
  const canvasArea = document.getElementById('canvasArea');

  // --- Menu wiring ---
  const menu = document.getElementById('menu');
  const backdrop = document.getElementById('backdrop');
  const openMenu = () => { menu.classList.add('open'); menu.setAttribute('aria-hidden','false'); backdrop.classList.add('show') };
  const closeMenu = () => { menu.classList.remove('open'); menu.setAttribute('aria-hidden','true'); backdrop.classList.remove('show') };
  document.getElementById('menuToggle').addEventListener('click',()=> menu.classList.contains('open')? closeMenu(): openMenu());
  document.getElementById('menuClose').addEventListener('click', closeMenu);
  backdrop.addEventListener('click', closeMenu);
  document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeMenu(); });

  // Manual sort buttons
  document.querySelectorAll('[data-sort]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      currentSort = btn.getAttribute('data-sort') || 'none';
      render();
    });
  });

  // --- Firestore live subscription ---
  // Listen to collection changes in real-time.
  // Using createdAt for deterministic base order (when "Clear sort" is selected)
  COL.orderBy('createdAt', 'asc').onSnapshot((snap)=>{
    const fresh = [];
    snap.forEach(doc=>{
      const d = doc.data() || {};
      fresh.push({ id: doc.id, name: d.name || 'Team', points: Number(d.points)||0, createdAt: d.createdAt?.toMillis?.() || 0 });
    });
    teams = fresh;
    render();
  });

  // --- Render with manual sorting only ---
  function render(){
    rows.innerHTML = '';

    let list = [...teams];
    switch(currentSort){
      case 'team-asc':
        list.sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:'base'})); break;
      case 'team-desc':
        list.sort((a,b)=>b.name.localeCompare(a.name, undefined, {sensitivity:'base'})); break;
      case 'points-asc':
        list.sort((a,b)=>a.points-b.points); break;
      case 'points-desc':
        list.sort((a,b)=>b.points-a.points); break;
      case 'none':
      default:
        // keep Firestore base order (createdAt asc)
        break;
    }

    const maxPoints = Math.max(1, ...list.map(t=>t.points||0));

    list.forEach((t, i) => {
      const tr = document.createElement('tr');
      const rank = i + 1;
      const medalClass = rank===1?'m1':rank===2?'m2':rank===3?'m3':'';

      tr.innerHTML = `
        <td class="rank"><span class="medal ${medalClass}">${rank}</span></td>
        <td>
          <div class="name"
               ondblclick="this.contentEditable='true'"
               onblur="this.contentEditable='false'; updateName('${t.id}', this.textContent)">${escapeHtml(t.name)}</div>
        </td>
        <td><span class="locked-points" ondblclick="editPoints(this, '${t.id}')">${t.points}</span></td>
        <td>
          <div class="row-actions">
            <button class="btn primary" onclick="delta('${t.id}', 1);">+1</button>
            <button class="btn primary" onclick="delta('${t.id}', 3);">+3</button>
            <button class="btn primary" onclick="delta('${t.id}', 5);">+5</button>
            <button class="btn primary" onclick="delta('${t.id}', 10);">+10</button>
            <button class="btn" onclick="delta('${t.id}', -1);">−1</button>
            <button class="btn danger" onclick="removeTeam('${t.id}');">Delete</button>
          </div>
          <div class="bar"><span style="inset:0 ${(1-((t.points||0)/maxPoints))*100}% 0 0"></span></div>
        </td>
      `;

      tr.addEventListener('mouseenter',()=>tr.classList.add('show-actions'));
      tr.addEventListener('mouseleave',()=>tr.classList.remove('show-actions'));
      rows.appendChild(tr);
    });
  }

  // --- Inline editing helpers ---
  function editPoints(el,id){
    const val = el.textContent.trim();
    const input = document.createElement('input');
    input.type = 'number';
    input.value = val;
    input.style.fontSize='22px';
    input.style.fontWeight='700';
    input.style.width='100px';
    input.onblur = () => { updatePoints(id, input.value); };
    input.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); input.blur(); }
    });
    el.replaceWith(input);
    input.focus();
    input.select();
  }

  // --- CSV helpers/export ---
  function toCsvValue(v){
    const s = String(v ?? '');
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }

  function getDisplayList(){
    let list = [...teams];
    switch(currentSort){
      case 'team-asc':
        list.sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:'base'})); break;
      case 'team-desc':
        list.sort((a,b)=>b.name.localeCompare(a.name, undefined, {sensitivity:'base'})); break;
      case 'points-asc':
        list.sort((a,b)=>a.points-b.points); break;
      case 'points-desc':
        list.sort((a,b)=>b.points-a.points); break;
      case 'none':
      default:
        break;
    }
    return list;
  }

  function downloadCSV(){
    const list = getDisplayList();
    const header = ['Rank','Team','Points'];
    const body = list.map((t, i)=> [i+1, t.name, t.points]);

    const lines = [header, ...body]
      .map(row => row.map(toCsvValue).join(','))
      .join('\n');

    const blob = new Blob(['\uFEFF' + lines], { type: 'text/csv;charset=utf-8;' });

    const ts = new Date();
    const pad = n=>String(n).padStart(2,'0');
    const fname = `quizwars_results_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.csv`;

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // --- CRUD (Firestore-backed) ---
  async function addTeam(name,points=0){
    const n = String(name).trim();
    if(!n) return;
    await COL.add({
      name:n,
      points:Number(points)||0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    });
  }

  async function removeTeam(id){
    await COL.doc(id).delete();
  }

  async function updatePoints(id,val){
    await COL.doc(id).update({ points: Number(val)||0 });
  }

  async function updateName(id,val){
    const n = String(val).trim();
    if(!n) return; // keep old if blank
    await COL.doc(id).update({ name: n });
  }

  async function delta(id,d){
    const ref = COL.doc(id);
    await db.runTransaction(async (tx)=>{
      const snap = await tx.get(ref);
      if(!snap.exists) return;
      const cur = Number(snap.data().points)||0;
      tx.update(ref, { points: cur + (Number(d)||0) });
    });
  }

  function escapeHtml(s){
    const map={ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' };
    return String(s).replace(/[&<>"']/g, m=>map[m])
  }

  // --- Form & buttons wiring ---
  const addTeamForm = document.getElementById('addTeamForm');
  addTeamForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    await addTeam(document.getElementById('teamName').value, document.getElementById('startPoints').value);
    addTeamForm.reset();
  });

  document.getElementById('resetAll').addEventListener('click', async ()=>{
    if(confirm('Clear all teams and scores for EVERYONE?')){
      const snap = await COL.get();
      const batch = db.batch();
      snap.forEach(doc=> batch.delete(doc.ref));
      await batch.commit();
    }
  });

  // NEW: hook up CSV button
  document.getElementById('downloadCsv').addEventListener('click', downloadCSV);

  // Expose for inline handlers
  window.editPoints = editPoints;
  window.updateName = updateName;
  window.removeTeam = removeTeam;
  window.delta = delta;
</script>
</body>
</html>
